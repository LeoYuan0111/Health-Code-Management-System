<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.healthcodebe.mapper.ComplainMapper">
    <resultMap id="BaseComplainMap" type="com.example.healthcodebe.entity.Complain">
        <result column="complain_id" property="complainId" jdbcType="VARCHAR" />
        <result column="time" property="time" jdbcType="TIMESTAMP" />
        <result column="id_number" property="idNumber" jdbcType="VARCHAR" />
        <result column="content" property="content" jdbcType="VARCHAR" />
        <result column="result" property="result" jdbcType="INTEGER" />
        <result column="reply" property="reply" jdbcType="VARCHAR" />
        <result column="withdraw" property="withdraw" jdbcType="INTEGER" />
    </resultMap>

<!--    展示一个用户的所有申诉-->
    <select id="getComplainById" resultMap="BaseComplainMap" parameterType="String">
        SELECT
        *
        FROM
        complain
        <where>
            id_number = #{id}
        </where>
        ORDER BY time DESC
    </select>

<!--    展示一个特定的申诉-->
    <select id="getComplainByComplainId" resultMap="BaseComplainMap" parameterType="String">
        SELECT
        *
        FROM
        complain
        <where>
            complain_id = #{complain_id}
        </where>
    </select>

<!--    按page展示申诉列表-->
    <select id="getComplainListByPage" resultMap="BaseComplainMap" parameterType="map">
        SELECT
        *
        FROM
        complain
        <where>
            result = #{condition.result}
        </where>
        ORDER BY time DESC
        LIMIT #{condition.page_size}
        OFFSET #{condition.offset}
    </select>

<!--    处理申诉-->
    <update id="dealComplain" parameterType="map">
        UPDATE complain
        <trim prefix="set" suffixOverrides=",">
            <if test="condition.reply != null">
                reply = #{condition.reply},
            </if>
            <if test="condition.result != null">
                result = #{condition.result},
            </if>
        </trim>
        <where>
            <if test="condition.complain_id != null">
                complain_id = #{condition.complain_id}
            </if>
        </where>
    </update>


    <update id="withDraw" parameterType="String">
        UPDATE complain
        <trim prefix="set" suffixOverrides=",">
            <if test="withdraw != null">
                withdraw = 1,
            </if>
        </trim>
        <where>
            <if test="complainId != null and complainId != ''">
                complain_id = #{complain_id}
            </if>
        </where>
    </update>


    <insert id="addComplain" useGeneratedKeys="true" keyProperty="complainId" parameterType="com.example.healthcodebe.entity.Complain">
        INSERT INTO complain
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="time != null">time,</if>
            <if test="idNumber != null and idNumber != ''">id_number,</if>
            <if test="content != null">content,</if>
            <if test="result != null">result,</if>
            <if test="reply != null">reply,</if>
            <if test="withdraw != null">withdraw,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="time != null">#{time},</if>
            <if test="idNumber != null and idNumber != ''">#{idNumber},</if>
            <if test="content != null">#{content},</if>
            <if test="result != null">#{result},</if>
            <if test="reply != null">#{reply},</if>
            <if test="withdraw != null">#{withdraw},</if>
        </trim>
    </insert>
</mapper>